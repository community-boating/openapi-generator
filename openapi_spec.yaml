openapi: 3.0.3
info:
  title: Simple API with JWT Auth
  version: 1.0.0
  description: A minimal OpenAPI spec with JWT authentication and simple models.

servers:
  - url: https://api.example.com

paths:
  /paths/dummyEnum:
    get:
      parameters:
        - in: query
          name: id # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: './shared.yaml#/components/schemas/DummyEnum'
  /member/getNoParams:
    get:
      summary: Test
      description: Tests Post.
      responses:
        '200':
          description: All good
          content:
            application/json:
              schema:
                $ref: './shared.yaml#/components/schemas/Boolean'
  
  /member/info:
    post:
      summary: Test
      description: Tests Post.
      security:
        - member: []
      tags:
        - Member
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonPublicParentDTO'
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonPublicParentDTO'
        '401':
          description: Invalid credentials
    get:
      summary: Test
      description: Tests Post.
      security:
        - member: []
      tags:
        - Member
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonPublicParentDTO'
        '401':
          description: Invalid credentials
  /member/eii:
    get:
      summary: Gets EII
      description: Returns current EII response.
      security:
        - member: [ ]
      tags:
        - Member
      responses:
        '200':
          description: Current EII Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentEIIResponseDTO'
  /member/eii/submit:
    post:
      summary: EII Submit
      description: Submits an EII response scholarship purposes.
      security:
        - member: [ ]
      tags:
        - Member
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EIIResponseDTO'
      responses:
        '200':
          description: Successfully submitted EII response
  /staff/balance/{number}:
    get:
      security:
        - staff: []
      tags:
        - Balance
      parameters:
        - in: path
          name: number
          required: true
          schema:
            type: string
          description: The balance number
      responses:
        '200':
          description: Updated balance dto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceDTO'
  /member/balance/{number}:
    get:
      security:
        - member: []
      tags:
        - Balance
      parameters:
        - in: path
          name: number
          required: true
          schema:
            type: string
          description: The balance number
      responses:
        '200':
          description: Updated balance dto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceDTO'
  /staff/balances:
    x-is-paginated: true
    get:
      summary: Gets a list of balances
      security:
        - staff: []
      tags:
        - Balance
      x-is-paginated: true
      parameters:
        - in: query
          name: personId
          required: false
          schema:
            type: integer
            minimum: 1
          description: The owner of the balance
      responses:
        '200':
          description: Successful fetch of balances
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BalanceDTO'
    post:
      summary: Updated or creates a balance
      security:
        - staff: []
      tags:
        - Balance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BalanceDTO'
      responses:
        '200':
          description: Updated balance dto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceDTO'

  /ap-class/get-eligible/{personId}:
    get:
      summary: Get eligible classes
      description: Gets eligible class information for the supplied person_id
      security:
        - member: []
      parameters:
        - in: path
          name: personId # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            minimum: 1
          description: The person id
      responses:
        '200':
          description: Successfully fetched classes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APEligibleClass'
        '204' :
          description: No classes to show
        '401' :
          description: Invalid credentials
        '403' :
          description: Invalid permissions

  /ap-class/get-future/{personId}:
    get:
      x-serve-example: true
      summary: Get eligible classes
      description: Gets eligible class information for the supplied person_id
      parameters:
        - in: path
          name: personId # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            minimum: 1
          description: The person id
      responses:
        '200':
          description: Successfully fetched classes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APFutureClass'
        '204' :
          description: No classes to show
        '401' :
          description: Invalid credentials
        '403' :
          description: Invalid permissions
  /staff/compass-order/{id}:
    get:
      description: 'Gets an existing order by id'
      parameters:
        - in: path
          name: id # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: The order id
      security:
        - staff: []
      tags:
        -  CompassOrder
      responses:
        '200':
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderWithDiscountsDTO'
  /staff/compass-order:
    post:
      description: 'Updates or inserts order and subobjects into the database for further use in the order system'
      parameters: []
      security:
        - staff: []
      tags:
        -  CompassOrder
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderDTO'
      responses:
        '200':
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderWithDiscountsDTO'
  /member/compass-order/{id}:
    get:
      parameters:
        - in: path
          name: id # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: The order id
      tags:
        -  CompassOrder
      security:
        - member: []
      description: 'Returns the current order this person has open'
      responses:
        '200':
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDTO'
        '404':
          description: Order doesn't exist
  /member/compass-order/proto:
    post:
      description: 'Returns an order with calculated values without creating anything in the database'
      parameters: [ ]
      tags:
        - CompassOrder
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderDTO'
      responses:
        '200':
          x-use-tracked: true
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                x-use-tracked: true
                allOf:
                  - $ref: '#/components/schemas/OrderDTO'
  /member/compass-order/open:
    get:
      tags:
        -  CompassOrder
      security:
        - member: []
      description: 'Returns the current order this person has open'
      responses:
        '200':
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDTO'
        '404':
          description: Order doesn't exist
  /member/compass-order:
    post:
      description: 'Updates or inserts order and subobjects into the database for further use in the order system'
      parameters: []
      security:
        - member: []
      tags:
        -  CompassOrder
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderDTO'
      responses:
        '200':
          description: Successfully updated/inserted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDTO'
  /orders/{id}/poll:
    parameters:
      - in: path
        name: id # Note the name is the same as in the path
        required: true
        schema:
          type: integer
          format: int64
          minimum: 1
        description: The order ID
    post:
      description: 'Polls order'
      tags:
        - CompassOrder
      responses:
        '200':
          description: Successfully cancelled the order
          content:
            application/json:
              schema:
                $ref: './shared.yaml#/components/schemas/OrderStateNew'
  /member/orders/cancel:
    post:
      description: 'Cancels current person order, deleting if possible'
      security:
        - member: []
      tags:
        - CompassOrder
      responses:
        '200':
          description: Successfully cancelled the order
  /staff/orders/cancel/{id}:
    post:
      description: 'Cancels an order, deleting if possible'
      parameters:
        - in: path
          name: id # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: The order ID
      security:
        - staff: []
      tags:
        - CompassOrder
      responses:
        '200':
          description: Successfully cancelled the order
  /catalog/syncClasses:
    post:
      description: 'Syncs the current catalog with prices from the db'
      x-one-of-permissions:
        -
          scope: admin
          type: ADMIN
      tags:
        - Catalog
      security:
        - staff: []
      responses:
        '200':
          description: Successfully syncs the catalog
  /catalog/inventory:
    get:
      description: 'Gets the current inventory'
      tags:
        - Catalog
      responses:
        '200':
          description: Successfully gets the inventory
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ItemStockDTO'
  /catalog/inventory/{id}:
    get:
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      description: 'Gets the current catalog'
      tags:
        - Catalog
      responses:
        '200':
          description: Successfully gets the catalog
          content:
            application/json:
              schema:
                type: integer
    post:
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      description: 'Updates the quantity of a specified item'
      x-one-of-permissions:
        -
          scope: admin
          type: ADMIN
      tags:
        - Catalog
      security:
        - staff: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StockChangeDTO'
      responses:
        '200':
          description: Successfully syncs the catalog
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ItemStockDTO'
  
  /catalog:
    get:
      description: 'Gets the current catalog'
      tags:
        - Catalog
      responses:
        '200':
          description: Successfully gets the catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogPublicDTO'
  /staff/catalog:
    get:
      description: 'Gets the current catalog'
      tags:
        - Catalog
      security:
        - staff: []
      responses:
        '200':
          description: Successfully gets the catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogDTO'
    post:
      description: 'Updates the current catalog'
      x-one-of-permissions:
        -
          scope: admin
          type: ADMIN
      tags:
        - Catalog
      security:
        - staff: []
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CatalogDTO'
      responses:
        '200':
          description: Successfully returns the updated catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogDTO'
  /staff/reports/orders:
    get:
      description: 'Gets order reports'
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date-time
        - in: query
          name: endDate
          schema:
            type: string
            format: date-time
        - in: query
          name: orderStatus
          schema:
            $ref: "./shared.yaml#/components/schemas/OrderStateNew"
      tags:
        - Report
      security:
        - staff: [ ]
      responses:
        '200':
          description: Successfully gets the order reports
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderReportsDTO'
  /staff/reports/stripe-payments:
    get:
      description: 'Gets stripe payment reports'
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date-time
        - in: query
          name: endDate
          schema:
            type: string
            format: date-time
        - in: query
          name: orderStatus
          schema:
            $ref: "./shared.yaml#/components/schemas/PaymentStatus"
      tags:
        - Report
      security:
        - staff: [ ]
      responses:
        '200':
          description: Successfully gets the order reports
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StripePaymentReportsDTO'
  /stripe/constants:
    get:
      description: 'Returns stripe constants'
      tags:
        - Stripe
      responses:
        '200':
          description: Successfully returns the stripe constants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StripeConstantsDTO'
  /staff/personNew/test:
    get:
      tags:
        - Member
      security:
        - staff: []
      description: 'Test new person dto'
      responses:
        '200':
          description: 'Success'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonDTO'

  /staff/payment:
    post:
      security:
        - staff: []
      description: 'Creates test payment intent'
      tags:
        - Payment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderPaymentDTO'
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderPaymentDTO'
  /member/checkout-session:
    get:
      security:
        - member: []
      tags:
        - Payment
      description: 'Creates a payment intent'
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutSessionDTO'
  /member/payment/cancel/{id}:
    post:
      security:
        - member: []
      parameters:
        - in: path
          name: id # Note the name is the same as in the path
          required: true
          schema:
            type: integer
            minimum: 1
      description: 'Cancels a payment'
      tags:
        - Payment
      responses:
        '200':
          description: Returns payment intent
  /member/payment:
    post:
      security:
        - member: []
      description: 'Creates a payment intent'
      tags:
        - Payment
      requestBody:
        x-use-tracked: true
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderPaymentDTO'
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderPaymentDTO'
  /member/donations:
    x-is-paginated: true
    get:
      security:
        - member: []
      description: 'Returns a list of donations'
      tags:
        - DonationPublic
      x-is-paginated: true
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DonationDTO'
  /member/donation/options:
    get:
      security:
        - member: [ ]
      description: 'Returns donation funds and initiatives'
      tags:
        - DonationPublic
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DonationOptionsDTO'
  /member/class/signups:
    x-is-paginated: true
    get:
      security:
        - member: [ ]
      description: 'Returns a list of ap class signups'
      tags:
        - ClassPublic
      x-is-paginated: true
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClassSignupDTO'
  /member/class/jp-signups:
    x-is-paginated: true
    get:
      security:
        - member: [ ]
      description: 'Returns a list of jp class signups'
      tags:
        - ClassPublic
      x-is-paginated: true
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JpClassSignupDTO'
  /member/classes/signup:
    post:
      description: 'Signs up for a class'
      tags:
        - ClassPublic
      security:
        - member: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassSignupRequestDTO'
      responses:
        '200':
          description: Successfully returns the updated catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassSignupResponseDTO'
  /stripe/paymentTest:
    post:
      security:
        - member: []
      description: 'Creates test payment intent'
      tags:
        - Stripe
      responses:
        '200':
          description: Returns payment intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentTestDTO'
components:
  securitySchemes:
    staff:
      type: http
      scheme: bearer
      bearerFormat: JWT
    member:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    StockChangeDTO:
      properties:
        stockChangeType:
          $ref: './shared.yaml#/components/schemas/StockChangeType'
        changeAmount:
          type: integer
    ItemStockDTO:
      properties:
        itemInstanceId:
          type: integer
          format: int64
        itemName:
          type: string
        stockAmountRemaining:
          type: integer
        stockAmountSold:
          type: integer
        stockAmountRefunded:
          type: integer
    PaymentTestDTO:
      properties:
        clientSecret:
          type: string
        sessionClientSecret:
          type: string
    StripeConstantsDTO:
      required: [publicKey, account, apiVersion, locale]
      properties:
        publicKey:
          type: string
        account:
          type: string
        apiVersion:
          type: string
        locale:
          type: string

    CashTransactionDTO:
      x-has-dto: true
      required: [cashDrawerId, transactionAmountCents]
      allOf:
        - $ref: './shared.yaml#/components/schemas/CashTransactionFull'
        - type: object
          properties:
            cashDrawerChangeId:
              $ref: '#/components/schemas/CashDrawersChangeDTO'
    CashDrawersChangeDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/CashDrawersChangeFull'
    BalanceTransactionDTO:
      x-has-dto: true
      required: [id, balanceId, transactionAmountCents]
      allOf:
        - $ref: './shared.yaml#/components/schemas/BalanceTransactionFull'
        #- type: properties
        #  properties:
        #    paymentId:
        #      type: integer
        #      format: int64
        #    lineItemId:
        #      type: integer
        #      format: int64
    BalanceDTO:
      x-has-dto: true
      required: [balanceCents, balanceType]
      allOf:
        - $ref: './shared.yaml#/components/schemas/BalanceFull'
    BalanceInternalDTO:
      x-has-dto: true
      required: [ balanceCents, balanceType ]
      allOf:
        - $ref: '#/components/schemas/BalanceDTO'
        - $ref: './shared.yaml#/components/schemas/BalanceInternal'
        - type: object
          properties:
            balanceTransactions:
              type: array
              items:
                $ref: '#/components/schemas/BalanceTransactionDTO'
    ClassSignupResponseDTO:
      type: object
      properties:
        classSignup:
          $ref: '#/components/schemas/ClassSignupDTO'
        jpClassSignup:
          $ref: '#/components/schemas/JpClassSignupDTO'
        errors:
          type: string
    ClassSignupRequestDTO:
      type: object
      properties:
        classSignup:
          $ref: '#/components/schemas/CreateClassSignupDTO'
        jpClassSignup:
          $ref: '#/components/schemas/CreateJpClassSignupDTO'
    ClassSignupOverrides:
      type: object
      properties:
        overrideCanEnroll:
          type: boolean
        overrideClassStarted:
          type: boolean
        overrideClassCancelled:
          type: boolean
        typeOverride:
          type: string
          maxLength: 1
          minLength: 1
    ValidateLineItemOverrides:
      type: object
      properties:
        overrideValidPeople:
          type: boolean
        overrideTypeCheck:
          type: boolean
        ClassSignupOverrides:
          $ref: '#/components/schemas/ClassSignupOverrides'
    CatalogPublicDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: './shared.yaml#/components/schemas/CatalogFull'
        - type: object
          properties:
            items:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemPublicDTO'
            discounts:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogDiscountPublicDTO'
    CatalogDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: './shared.yaml#/components/schemas/CatalogInternalFull'
        - type: object
          properties:
            items:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemDTO'
            taxes:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogTaxDTO'
            categories:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogCategoryDTO'
            discounts:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogDiscountDTO'
            products:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/CatalogProductDTO'
    CatalogTaxDTO:
      x-has-dto: true
      required: [ taxName, taxRate, taxMinValueCents ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/TaxFull'
    CatalogDiscountCategoryDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountCategoryFull'
    CatalogCategoryDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/CategoryFull'
    CatalogDiscountPublicDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountFull'
        - type: object
          properties:
            instances:
              x-parent-variable: discountId
              type: array
              items:
                $ref: '#/components/schemas/CatalogDiscountInstancePublicDTO'
    CatalogDiscountDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountFull'
        - type: object
          properties:
            categories:
              x-parent-variable: discountId
              type: array
              items:
                $ref: '#/components/schemas/CatalogDiscountCategoryDTO'
            instances:
              x-parent-variable: discountId
              type: array
              items:
                $ref: '#/components/schemas/CatalogDiscountInstanceDTO'
    CatalogDiscountInstancePublicDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountInstanceFull'
    CatalogDiscountInstanceDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountInstanceInternalFull'
    CatalogItemInstancePublicDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInstanceRef'
        - $ref: './shared.yaml#/components/schemas/ItemInstanceBase'
    CatalogItemInstanceDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInstanceFull'
    CatalogItemPublicDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemRef'
        - $ref: './shared.yaml#/components/schemas/ItemFull'
        - type: object
          properties:
            #classTypeId:
            #  nullable: true
            #  type: integer
            #classInstanceId:
            #  nullable: true
            #  type: integer
            #membershipTypeId:
            #  nullable: true
            #  type: integer
            #productId:
            #  nullable: true
            #  type: integer
            #  format: int64
            itemInstances:
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemInstancePublicDTO'
            itemCategories:
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemCategoryPublicDTO'

    CatalogItemDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInternalFull'
        - type: object
          properties:
            #classTypeId:
            #  nullable: true
            #  type: integer
            #classInstanceId:
            #  nullable: true
            #  type: integer
            #membershipTypeId:
            #  nullable: true
            #  type: integer
            #productId:
            #  nullable: true
            #  type: integer
            #  format: int64
            itemInstances:
              x-parent-variable: itemId
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemInstanceDTO'
            itemDiscounts:
              x-parent-variable: itemId
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemDiscountDTO'
            itemTaxes:
              x-parent-variable: itemId
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemTaxDTO'
            itemCategories:
              x-parent-variable: item
              type: array
              items:
                $ref: '#/components/schemas/CatalogItemCategoryDTO'
    CatalogItemDiscountDTO:
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemDiscountFull'
    CatalogItemTaxDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemTaxFull'
    CatalogItemCategoryPublicDTO:
      required: [categoryId]
      x-has-dto: true
      allOf:
        - $ref: "./shared.yaml#/components/schemas/ItemCategoryFull"
    CatalogItemCategoryDTO:
      required: [categoryId]
      x-has-dto: true
      allOf:
        - $ref: "./shared.yaml#/components/schemas/ItemCategoryInternalFull"
    CatalogProductDTO:
      required: [productName, productDescription, active]
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ProductFull'
    CatalogSubscriptionDTO:
      required: [name, billingCycle]
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/SubscriptionFull'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/CatalogSubscriptionItemDTO'
    CatalogSubscriptionItemDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/SubscriptionItemFull'
    OrderWithDiscountsDTO:
      type: object
      properties:
        order:
          $ref: '#/components/schemas/OrderDTO'
        availableDiscounts:
          type: array
          items:
            $ref: '#/components/schemas/LineItemAvailableDiscount'
    LineItemAvailableDiscount:
      type: object
      properties:
        lineItemId:
          $ref: './shared.yaml#/components/schemas/LineItemRef'
        discountId:
          type: integer
        instanceId:
          type: integer
        discountType:
          $ref: './shared.yaml#/components/schemas/DiscountType'
        amountCents:
          type: integer
          format: int64
        percent:
          type: string
        discountName:
          type: string
    OrderSummaryDTO:
      type: object
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderBase'
        - $ref: './shared.yaml#/components/schemas/OrderCalculated'
    OrderDTO:
      x-has-dto: true
      x-dao-type: OrderNew
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderFull'
        - $ref: './shared.yaml#/components/schemas/OrderCalculated'
        - type: object
          required: [lineItems, orderNum, version]
          properties:
            #itemCount:
            #  type: integer
            lineItems:
              type: array
              items:
                $ref: '#/components/schemas/LineItemDTO'
            appliedTaxes:
              type: array
              readOnly: true
              items:
                $ref: '#/components/schemas/OrderTaxDTO'
            orderPayments:
              type: array
              readOnly: true
              items:
                $ref: '#/components/schemas/OrderPaymentDTO'
    CheckoutSessionDTO:
      type: object
      properties:
        checkoutSecret:
          type: string
    PaymentSourceDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/PaymentSourceFull'
      #  - type: object
      #    properties:
      #      balanceSource:
      #        $ref: '#/components/schemas/BalanceRef'
    OrderPaymentDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderPaymentFull'
        - type: object
          properties:
            paymentSource:
              $ref: '#/components/schemas/PaymentSourceDTO'
            cashTransaction:
              $ref: '#/components/schemas/CashTransactionDTO'
            stripeTransaction:
              nullable: true
              $ref: '#/components/schemas/StripeTransactionDTO'
            balanceTransaction:
              nullable: true
              $ref: '#/components/schemas/BalanceTransactionDTO'
    CreateOrderPaymentDTO:
      type: object
      required: [ orderId, payment ]
      properties:
        orderId:
          $ref: './shared.yaml#/components/schemas/OrderRef'
        payment:
          $ref: '#/components/schemas/OrderPaymentDTO'
        saveCard:
          type: boolean
    StripeTransactionDTO:
      required: [stripePaymentIntent, transactionAmountCents]
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/StripeTransactionFull'
    OrderTaxDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderTaxFull'
    LineItemDTORef:
      x-has-dto: true
      x-dao-type: LineItem
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemRef'
    LineItemDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemFull'
        - $ref: '#/components/schemas/LineItemDTORef'
        - $ref: './shared.yaml#/components/schemas/LineItemCalculated'
        - type: object
          properties:
            parentItemId:
              $ref: '#/components/schemas/LineItemDTORef'
            itemInstanceId:
              $ref: './shared.yaml#/components/schemas/ItemInstanceRef'
            #subscriptionId:
            #  $ref: '#/components/schemas/SubscriptionDTORef'
            classSignup:
              nullable: true
              $ref: '#/components/schemas/PurchaseClassSignupDTO'
            membership:
              nullable: true
              $ref: '#/components/schemas/PurchaseMembershipDTO'
            donation:
              nullable: true
              $ref: '#/components/schemas/PurchaseDonationDTO'
            card:
              nullable: true
              $ref: '#/components/schemas/PurchaseCardDTO'
            giftCard:
              nullable: true
              $ref: '#/components/schemas/PurchaseGiftCardDTO'
            guestPrivs:
              nullable: true
              $ref: '#/components/schemas/PurchaseGuestPrivilegesDTO'
            damageWaiver:
              nullable: true
              $ref: '#/components/schemas/PurchaseDamageWaiverDTO'
            stockChange:
              nullable: true
              $ref: '#/components/schemas/PurchaseStockedItemDTO'
            discounts:
              x-parent-variable: lineItemId
              type: array
              items:
                $ref: '#/components/schemas/LineItemDiscountDTO'
            refunds:
              x-parent-variable: lineItemId
              type: array
              items:
                $ref: '#/components/schemas/LineItemRefundDTO'
    LineItemDiscountDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemDiscountInstanceFull'
        - type: object
          properties:
            appliedCode:
              type: string
              maxLength: 100
              readOnly: true

    LineItemRefundDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemRefundFull'
        - type: object
          properties:
            restock:
              readOnly: true
              allOf:
                - $ref: '#/components/schemas/PurchaseStockedItemDTO'
            includeTaxes:
              type: array
              items:
                $ref: '#/components/schemas/LineItemRefundTaxDTO'
            amountToRefundTotalCents:
              readOnly: true
              type: integer
              format: int64
    LineItemRefundTaxDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemRefundTaxFull'
    #Maybe we split this into different dtos for different types (Purchase, Stock, Refund), idk (its all the same table)
    PurchaseStockedItemDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInstanceStockChangeFull'
    PurchaseDamageWaiverDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DamageWaiverFull'
    PurchaseGuestPrivilegesDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/GuestPrivsFull'
    JpClassSignupDTO:
      x-has-dto: true
      required: [ instanceId, personId ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/JpClassSignupFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonNameDTO'
    CreateClassSignupDTO:
      allOf:
        - $ref: './shared.yaml#/components/schemas/ClassSignupFull'
    CreateJpClassSignupDTO:
      allOf:
        - $ref: './shared.yaml#/components/schemas/JpClassSignupFull'
    ClassSignupDTO:
      x-has-dto: true
      required: [ instanceId, personId ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ClassSignupInternalFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonNameDTO'
            lineItemId:
              $ref: './shared.yaml#/components/schemas/LineItemOrderRef'
    PurchaseClassSignupDTO:
      x-has-dto: true
      required: [instanceId, personId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ClassSignupFull'
    MembershipDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/MembershipInternal'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonNameDTO'
            lineItemId:
              $ref: './shared.yaml#/components/schemas/LineItemOrderRef'
    PurchaseMembershipDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/MembershipFull'
    DonationDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DonationInternalFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonNameDTO'
            lineItemId:
              $ref: './shared.yaml#/components/schemas/LineItemOrderRef'
    PurchaseDonationDTO:
      x-has-dto: true
      required: [fundId,initiativeId, state]
      allOf:
        - $ref: './shared.yaml#/components/schemas/DonationFull'
        #- type: object
        #  properties:
        #    personId:
        #      type: integer
    EIIResponseDTO:
      x-has-dto: true
      required: [workingAdults, nonWorkingAdults, children, householdIncome]
      properties:
        workingAdults:
          type: integer
        nonWorkingAdults:
          type: integer
        children:
          type: integer
        householdIncome:
          type: integer
          format: int64
    CurrentEIIResponseDTO:
      x-has-dto: true
      allOf:
        - $ref: '#/components/schemas/EIIResponseDTO'
        - type: object
          properties:
            computedPrice:
              type: integer
    PersonIdOnlyDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonRef'
    PersonNameDTO:
      x-has-dto: true
      allOf:
        - $ref: '#/components/schemas/PersonIdOnlyDTO'
        - $ref: './shared.yaml#/components/schemas/PersonNameInfo'
    CardDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/CardFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonNameDTO'
    PurchaseCardDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: './shared.yaml#/components/schemas/CardFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonPublicDTO'
    PurchaseGiftCardDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/BalanceTransactionFull'
        - type: object
          properties:
            cardNum:
              writeOnly: true
              type: string
            isRecharge:
              writeOnly: true
              type: boolean
            balanceId:
              readOnly: true
              allOf:
                - $ref: '#/components/schemas/BalanceDTO'
    
    PersonSubscriptionDTO:
      x-has-dto: true
      required: [id, personId, subscriptionId, billingCycle]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonSubscriptionFull'
    APEligibleClass:
      type: object
      properties:
        instanceId:
          type: integer
          example: 117
        typeName:
          type: string
          example: Intermediate 2
        sessionCount:
          type: integer
          example: 2
        sessionDates:
          type: array
          example: [01-APR-2010, 02-APR-2010]
          items:
            type: string
            format: date
        signupsAvailable:
          type: boolean
          example: T
        nextSignupsOpen:
          type: string
          format: date-time
        nextSignupsCount:
          type: integer
          example: 10
        instructor:
          type: string
          example: Joe L.
        location:
          type: string
          example: Dockhouse
        booleanEnumTest:
          $ref: './shared.yaml#/components/schemas/Boolean'
          example: 'T'
    APFutureClass:
      type: object
      properties:
        enumTest:
          $ref: "./shared.yaml#/components/schemas/EnumTest"
          example: 'A'
        instanceId:
          type: integer
          example: 117
        typeName:
          type: string
          example: Intermediate 2
        sessionCount:
          type: integer
          example: 2
        sessionDates:
          type: array
          example: [01-APR-2010, 02-APR-2010]
          items:
            type: string
            format: date
        sessionLengthMinutes:
          type: integer
          example: 120
        signupsAvailable:
          type: boolean
          example: Y
        nextSignupsOpen:
          type: string
          format: date-time
        nextSignupsCount:
          type: integer
          example: 10
        instructor:
          type: string
          example: Joe L.
        location:
          type: string
          example: Dockhouse
    PersonPublicDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonRef'
        - $ref: './shared.yaml#/components/schemas/PersonBase'
        - $ref: './shared.yaml#/components/schemas/PersonPublic'
        - type: object
          properties:
            isLocked:
              type: boolean
            phones:
              type: array
              items:
                $ref: '#/components/schemas/PhoneDTO'
            addresses:
              type: array
              items:
                $ref: '#/components/schemas/AddressDTO'
            referrals:
              x-parent-variable: personId
              type: array
              items:
                $ref: '#/components/schemas/PersonReferralDTO'

    PersonDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonFull'
        - $ref: '#/components/schemas/PersonPublicDTO'
        - type: object
          properties:
            cards:
              type: array
              x-base-type: false
              items:
                $ref: '#/components/schemas/CardDTO'
            memberships:
              type: array
              x-base-type: MembershipDTO
              items:
                $ref: '#/components/schemas/MembershipDTO'
            relationsA:
              x-column-parent-fk: A
              x-base-type: false
              type: array
              items:
                $ref: '#/components/schemas/PersonRelationDTO'
            relationsB:
              x-column-parent-fk: B
              x-base-type: false
              type: array
              items:
                $ref: '#/components/schemas/PersonRelationDTO'
    PersonPublicChildAndParentDTO:
      x-has-dto: true
      allOf:
        - $ref: '#/components/schemas/PersonPublicDTO'
        - type: object
          properties:
            currentMemberships:
              readOnly: true
              type: array
              items:
                $ref: '#/components/schemas/MembershipDTO'
            currentCards:
              readOnly: true
              type: array
              items:
                $ref: '#/components/schemas/CardDTO'
            emergencyContacts:
              maxLength: 3
              type: array
              items:
                $ref: '#/components/schemas/PersonPublicRelatedDTO'
            purchaseRecipients:
              maxLength: 25
              type: array
              items:
                $ref: '#/components/schemas/PersonPublicRelatedDTO'
    PersonPublicChildDTO:
      x-has-dto: true
      allOf:
        - $ref: '#/components/schemas/PersonPublicChildAndParentDTO'
        - $ref: '#/components/schemas/PersonPublicRelatedDTO'
    PersonPublicParentDTO:
      x-has-dto: true
      allOf:
        - $ref: '#/components/schemas/PersonPublicChildAndParentDTO'
        - type: object
          properties:
            children:
              maxLength: 10
              type: array
              items:
                $ref: '#/components/schemas/PersonPublicChildDTO'
    PersonPublicRelatedDTO:
      x-has-dto: true
      x-sub-variable: B
      x-sub-type: PersonRelationInterfaceI
      allOf:
        - $ref: '#/components/schemas/PersonPublicDTO'
        - $ref: './shared.yaml#/components/schemas/PersonRelationBase'
        - $ref: './shared.yaml#/components/schemas/Deletable'
        - type: object
          properties:
            aTitle:
              readOnly: true
              type: string
            bTitle:
              readOnly: true
              type: string
    PersonRelationDTO:
      x-has-dto: true
      required: [ assignId ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonRelation'
        - $ref: '#/components/schemas/PersonDTO'
        - $ref: './shared.yaml#/components/schemas/Deletable'
        - type: object
          properties:
            A:
              $ref: '#/components/schemas/PersonDTO'
            B:
              $ref: '#/components/schemas/PersonDTO'
            aTitle:
              readOnly: true
              type: string
            bTitle:
              readOnly: true
              type: string
    PhoneBaseDTO:
      x-has-dto: true
      x-has-dao: false
      allOf:
        - $ref: './shared.yaml#/components/schemas/Phone'
    PhoneDTO:
      x-has-dto: true
      x-has-dao: false
      x-sub-variable: phoneId
      x-sub-type: PersonPhoneDAO
      allOf:
        - $ref: '#/components/schemas/PhoneBaseDTO'
        - $ref: './shared.yaml#/components/schemas/PersonPhoneBase'
        - $ref: './shared.yaml#/components/schemas/Deletable'
    PersonReferralDTO:
      x-has-dto: true
      required: [assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonReferral'
        - $ref: './shared.yaml#/components/schemas/Deletable'
    AddressBaseDTO:
      x-has-dto: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/Address'
    AddressDTO:
      x-has-dto: true
      x-sub-variable: addressId
      x-sub-type: PersonAddressDAO
      allOf:
        - $ref: '#/components/schemas/AddressBaseDTO'
        - $ref: './shared.yaml#/components/schemas/PersonAddressBase'
        - $ref: './shared.yaml#/components/schemas/Deletable'
    ValidationTestDTO:
      type: object
      properties:
        testA:
          type: string
          maxLength: 100
          minLength: 10
        testB:
          type: integer
          minimum: 1
          maximum: 25
        testC:
          type: string
          pattern: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$
    DonationFundDTO:
      type: object
      allOf:
        - $ref: './shared.yaml#/components/schemas/DonationFundFull'
    DonationInitiativeDTO:
      type: object
      allOf:
        - $ref: './shared.yaml#/components/schemas/DonationInitiativeFull'
    DonationOptionsDTO:
      type: object
      properties:
        donationFunds:
          type: array
          items:
            $ref: '#/components/schemas/DonationFundDTO'
        donationInitiatives:
          type: array
          items:
            $ref: '#/components/schemas/DonationInitiativeDTO'
    ReportMetaEntryDTO:
      x-has-dto: true
      type: object
      required: [key, message]
      properties:
        key:
          type: string
        message:
          type: string
    ReportMetaDTO:
      x-has-dto: true
      type: object
      required: [title, status, entries]
      properties:
        title:
          type: string
        status:
          $ref: "./shared.yaml#/components/schemas/ReportMetaType"
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReportMetaEntryDTO'
    WithSubMeta:
      x-has-dto: true
      type: object
      properties:
        meta:
          type: array
          items:
            $ref: "#/components/schemas/ReportMetaDTO"
    OrderPaymentReportDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: "./shared.yaml#/components/schemas/OrderPaymentBase"
        - $ref: "./shared.yaml#/components/schemas/OrderPaymentRef"
    ItemDiscountReportDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: "./shared.yaml#/components/schemas/ItemDiscountBase"
    OrderItemReportDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: "./shared.yaml#/components/schemas/LineItemBase"
        - $ref: "./shared.yaml#/components/schemas/LineItemRef"
        - type: object
          properties:
            discountReports:
              type: array
              items:
                $ref: '#/components/schemas/ItemDiscountReportDTO'
    OrderReportBase:
      x-has-dto: true
      type: object
      properties:
        totalAmountPaidLineItems:
          type: integer
          format: int64
        totalAmountBaseLineItems:
          type: integer
          format: int64
        totalAmountTotalLineItems:
          type: integer
          format: int64
        totalAmountDiscountLineItems:
          type: integer
          format: int64
        totalAmountPaymentsPaid:
          type: integer
          format: int64
        totalAmountStripePaymentsPaid:
          type: integer
          format: int64
    OrderReportDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: '#/components/schemas/OrderReportBase'
        - $ref: "./shared.yaml#/components/schemas/OrderBase"
        - $ref: "./shared.yaml#/components/schemas/OrderRef"
        - type: object
          properties:
            itemReports:
              type: array
              items:
                $ref: '#/components/schemas/OrderItemReportDTO'
            paymentReports:
              type: array
              items:
                $ref: '#/components/schemas/OrderPaymentReportDTO'
    OrderReportsDTO:
      x-has-dto: true
      type: object
      required: [orderReports]
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: '#/components/schemas/OrderReportBase'
        - type: object
          properties:
            orderReports:
              type: array
              items:
                $ref: '#/components/schemas/OrderReportDTO'
            totalTotalAmountFromOrders:
              type: integer
              format: int64
            totalBaseAmountFromOrders:
              type: integer
              format: int64
            totalPaidAmountFromOrders:
              type: integer
              format: int64
    StripePaymentReportDTO:
      x-has-dto: true
      type: object
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - $ref: "./shared.yaml#/components/schemas/StripeTransactionBase"
    StripePaymentReportsDTO:
      x-has-dto: true
      type: object
      required: [ orderReports ]
      allOf:
        - $ref: "#/components/schemas/WithSubMeta"
        - type: object
          properties:
            paymentReports:
              type: array
              items:
                $ref: '#/components/schemas/StripePaymentReportDTO'
