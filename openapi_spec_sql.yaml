openapi: 3.0.0
info:
  version: '1'
  title: ''
  description: ''
paths: {}
components:
  securitySchemes: {}
  schemas:
    Catalog:
      x-has-dao: true
      required: [assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/CatalogInternalFull'
        - type: object
          properties:
            items:
              x-parent-variable: catalogId
              #x-column-parent-fk: line
              type: array
              items:
                $ref: '#/components/schemas/Item'
            taxes:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/Tax'
            categories:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/Category'
            discounts:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/Discount'
            products:
              x-parent-variable: catalogId
              type: array
              items:
                $ref: '#/components/schemas/Product'
    Product:
      x-has-dao: true
      required: [assignId, productName, productDescription, active, catalogId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ProductFull'
        - type: object
          properties:
            catalogId:
              $ref: '#/components/schemas/Catalog'

    Item:
      x-has-dao: true
      required: [assignId, type]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemFull'
        - type: object
          properties:
            classTypeId:
              $ref: '#/components/schemas/ApClassType'
            classInstanceId:
              $ref: '#/components/schemas/ApClassInstance'
            membershipTypeId:
              $ref: '#/components/schemas/MembershipType'
            productId:
              $ref: '#/components/schemas/Product'
            catalogId:
              $ref: '#/components/schemas/Catalog'
            itemInstances:
              type: array
              items:
                $ref: '#/components/schemas/ItemInstance'

    DiscountCategory:
      x-has-dao: true
      required: [assignId, discountId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountCategoryFull'
        - type: object
          properties:
            discountId:
              $ref: '#/components/schemas/Discount'
            categoryId:
              $ref: '#/components/schemas/Category'


    ItemCategory:
      x-has-dao: true
      required: [assignId, item, categoryId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemCategoryFull'
        - type: object
          properties:
            assignId:
              x-col-primary: true
              type: integer
              format: int64
            item:
              $ref: '#/components/schemas/Item'
            categoryId:
              $ref: '#/components/schemas/Category'

    Category:
      x-has-dao: true
      required: [assignId, categoryName, description, catalogId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/CategoryFull'
        - type: object
          properties:
            catalogId:
              $ref: '#/components/schemas/Catalog'

    ItemInstance:
      x-has-dao: true
      required: [assignId, itemId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInstanceFull'
        - type: object
          properties:
            itemId:
              $ref: '#/components/schemas/Item'

    ItemInstanceStockChange:
      x-has-dao: true
      required: [itemInstanceId, changeAmount, stockChangeType]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemInstanceStockChangeFull'
        - type: object
          properties:
            itemInstanceId:
              $ref: '#/components/schemas/ItemInstance'
            lineItemId:
              $ref: '#/components/schemas/LineItem'

    LineItem:
      x-has-dao: true
      required: [assignId, orderId, itemInstanceId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemFull'
        - type: object
          properties:
            parentItemId:
              $ref: '#/components/schemas/LineItem'
            orderId:
              $ref: '#/components/schemas/OrderNew'
            itemInstanceId:
              $ref: '#/components/schemas/ItemInstance'
            subscriptionId:
              $ref: '#/components/schemas/PersonSubscription'
            classSignup:
              nullable: true
              $ref: '#/components/schemas/ClassSignup'
            membership:
              nullable: true
              $ref: '#/components/schemas/MembershipDAO'
            donation:
              nullable: true
              $ref: '#/components/schemas/DonationDAO'
            card:
              nullable: true
              $ref: '#/components/schemas/CardDAO'
            giftCard:
              nullable: true
              $ref: '#/components/schemas/BalanceTransaction'
            guestPrivs:
              nullable: true
              $ref: '#/components/schemas/GuestPrivsDAO'
            damageWaiver:
              nullable: true
              $ref: '#/components/schemas/DamageWaiver'
            stockChange:
              nullable: true
              $ref: '#/components/schemas/ItemInstanceStockChange'
            discounts:
              x-parent-variable: lineItemId
              type: array
              items:
                $ref: '#/components/schemas/LineItemDiscountInstance'
            refunds:
              x-parent-variable: lineItemId
              type: array
              items:
                $ref: '#/components/schemas/LineItemRefund'

    LineItemRefund:
      x-has-dao: true
      required: [assignId, lineItemId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemRefundInternalFull'
        - type: object
          properties:
            lineItemId:
              $ref: '#/components/schemas/LineItem'
            stockChangeId:
              $ref: '#/components/schemas/ItemInstanceStockChange'
            taxes:
              x-parent-variable: lineItemRefundId
              type: array
              items:
                $ref: '#/components/schemas/LineItemRefundTax'
    LineItemRefundTax:
      x-has-dao: true
      required: [taxId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemRefundTaxInternalFull'
        - type: object
          properties:
            lineItemRefundId:
              $ref: '#/components/schemas/LineItemRefund'
            taxId:
              $ref: '#/components/schemas/OrderTax'

    ItemTax:
      x-has-dao: true
      required: [assignId, itemId, taxId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemTaxFull'
        - type: object
          properties:
            itemId:
              $ref: '#/components/schemas/Item'
            taxId:
              $ref: '#/components/schemas/Tax'

    Tax:
      x-has-dao: true
      required: [assignId, taxName, taxRate, taxMinValueCents, catalogId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/TaxFull'
        - type: object
          properties:
            catalogId:
              $ref: '#/components/schemas/Catalog'

    OrderTax:
      x-has-dao: true
      x-no-interface: true
      required: [assignId, taxId, order]
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderTaxFull'
        - type: object
          properties:
            taxId:
              $ref: '#/components/schemas/Tax'
            orderId:
              $ref: '#/components/schemas/OrderNew'

    LineItemDiscountInstance:
      x-has-dao: true
      required: [assignId, lineItemId, discountInstanceId, discountType]
      allOf:
        - $ref: './shared.yaml#/components/schemas/LineItemDiscountInstanceInternalFull'
        - type: object
          properties:
            lineItemId:
              $ref: '#/components/schemas/LineItem'
            discountInstanceId:
              $ref: '#/components/schemas/DiscountInstance'

    OrderNew:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderFull'
        - type: object
          required: [assignId, status, version]
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItems:
              x-parent-variable: orderId
              items:
                $ref: '#/components/schemas/LineItem'
            appliedTaxes:
              x-parent-variable: orderId
              items:
                $ref: '#/components/schemas/OrderTax'
            orderPayments:
              x-parent-variable: orderId
              items:
                $ref: '#/components/schemas/OrderPayment'

    ItemDiscount:
      x-has-dao: true
      required: [assignId, itemId, discountId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/ItemDiscountFull'
        - type: object
          properties:
            itemId:
              $ref: '#/components/schemas/Item'
            discountId:
              $ref: '#/components/schemas/Discount'
    PaymentSource:
      x-has-dao: true
      required: [ assignId, orderId, paymentSource, paymentAmountCents, paymentStatus ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PaymentSourceFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'
            balanceSource:
              $ref: '#/components/schemas/Balance'

    OrderPayment:
      x-has-interface: true
      x-no-interface: true
      x-has-dao: true
      required: [assignId, orderId, paymentSource, paymentAmountCents, paymentStatus]
      allOf:
        - $ref: './shared.yaml#/components/schemas/OrderPaymentInternalFull'
        - type: object
          properties:
            orderId:
              $ref: '#/components/schemas/OrderNew'
            paymentSource:
              $ref: '#/components/schemas/PaymentSource'
            stripeTransaction:
              $ref: '#/components/schemas/StripeTransaction'
            cashTransaction:
              $ref: '#/components/schemas/CashTransaction'
            balanceTransaction:
              $ref: '#/components/schemas/BalanceTransaction'

    BalanceTransaction:
      x-has-dao: true
      required: [assignId, balanceId, transactionAmountCents]
      allOf:
        - $ref: './shared.yaml#/components/schemas/BalanceTransactionInternalFull'
        - type: object
          properties:
            balanceId:
              $ref: '#/components/schemas/Balance'
            paymentId:
              $ref: '#/components/schemas/OrderPayment'
            lineItemId:
              x-backref-name: giftCard
              allOf:
                - $ref: '#/components/schemas/LineItem'

    Balance:
      x-has-dao: true
      required: [assignId, personId, balanceCents, balanceType]
      allOf:
        - $ref: './shared.yaml#/components/schemas/BalanceInternal'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'

    StripeTransaction:
      x-has-dao: true
      required: [assignId, stripePaymentIntent, transactionAmountCents]
      allOf:
        - $ref: './shared.yaml#/components/schemas/StripeTransactionFull'
        - type: object
          properties:
            payments:
              type: array
              x-parent-variable: stripeTransaction
              items:
                $ref: '#/components/schemas/OrderPayment'

    CashTransaction:
      x-has-dao: true
      required: [assignId, cashDrawerId, transactionAmountCents]
      allOf:
        - $ref: './shared.yaml#/components/schemas/CashTransactionInternalFull'
        - type: object
          properties:
            paymentId:
              $ref: '#/components/schemas/OrderPayment'
            cashDrawerChangeId:
              $ref: '#/components/schemas/CashDrawersChange'

    CashDrawersChange:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/CashDrawersChangeFull'
        - type: object
          properties:
            cashDrawerId:
              $ref: '#/components/schemas/CashDrawer'
    ApClassType:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ApClassTypeRef'

    ApClassInstance:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ApClassInstanceRef'
    ClassSignup:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/ClassSignupFull'
        - type: object
          properties:
            signupId:
              x-col-primary: true
              x-table-name: AP_CLASS_SIGNUPS
              type: integer
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItemId:
              x-backref-name: classSignup
              allOf:
                - $ref: '#/components/schemas/LineItem'
            instanceId:
              $ref: '#/components/schemas/ApClassInstance'
    GuestPrivsDAO:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/GuestPrivsFull'
        - type: object
          properties:
            assignId:
              x-table-name: guest_privs
              x-col-primary: true
              type: integer
            membershipId:
              $ref: '#/components/schemas/MembershipDAO'
            lineItemId:
              x-backref-name: guestPrivs
              allOf:
                - $ref: '#/components/schemas/LineItem'
    DamageWaiver:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DamageWaiverFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItemId:
              x-backref-name: damageWaiver
              allOf:
                - $ref: '#/components/schemas/LineItem'
    PersonSubscription:
      x-has-dao: true
      required: [assignId, personId, subscriptionId, billingCycle]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonSubscriptionFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'
            subscriptionId:
              $ref: '#/components/schemas/Subscription'

    Subscription:
      x-has-dao: true
      required: [assignId, name, billingCycle]
      allOf:
        - $ref: './shared.yaml#/components/schemas/SubscriptionFull'

    SubscriptionItem:
      x-has-dao: true
      required: [assignId, subscriptionId, itemId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/SubscriptionItemFull'
        - type: object
          properties:
            subscriptionId:
              $ref: '#/components/schemas/Subscription'
            itemId:
              $ref: '#/components/schemas/Item'

    PersonPhoneDAO:
      x-has-dao: true
      x-sub-type: Phone
      x-sub-variable: phoneId
      required: [personPhoneAssignId, personId, phoneId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonPhoneFull'
        - $ref: './shared.yaml#/components/schemas/DBHistory'
        - type: object
          properties:
            personPhoneAssignId:
              x-dto-column: assign_id
              x-table-name: person_phone
              x-col-primary: true
              type: integer
              format: int64
            personId:
              $ref: '#/components/schemas/PersonDAO'
            phoneId:
              $ref: '#/components/schemas/PhoneDAO'
    PhoneDAO:
      x-has-dao: true
      required: [assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/Phone'
        - $ref: './shared.yaml#/components/schemas/DBHistory'
        - type: object
          properties:
            assignId:
              x-table-name: phone
              x-col-primary: true
              type: integer
              format: int64
            persons:
              type: array
              items:
                $ref: '#/components/schemas/PersonPhoneDAO'
    PersonAddressDAO:
      x-has-interface: true
      x-has-dao: true
      x-has-dto: false
      x-sub-type: Address
      x-sub-variable: addressId
      required: [personAddressAssignId, line1, country, personId, addressId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonAddressFull'
        - $ref: './shared.yaml#/components/schemas/DBHistory'
        - type: object
          properties:
            personAddressAssignId:
              x-dto-column: assign_id
              x-table-name: person_address
              x-col-primary: true
              type: integer
              format: int64
            personId:
              $ref: '#/components/schemas/PersonDAO'
            addressId:
              allOf:
                - $ref: '#/components/schemas/AddressDAO'
    AddressDAO:
      type: object
      x-has-dao: true
      required: [assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/Address'
        - $ref: './shared.yaml#/components/schemas/DBHistory'
        - type: object
          properties:
            assignId:
              x-table-name: address
              x-col-primary: true
              type: integer
              format: int64
            persons:
              type: array
              items:
                $ref: '#/components/schemas/PersonAddressDAO'

    PersonReferralDAO:
      x-has-dao: true
      required: [personId, assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonReferral'
        - $ref: './shared.yaml#/components/schemas/DBHistory'
        - type: object
          properties:
            assignId:
              x-table-name: person_referral
              x-col-primary: true
              type: integer
              format: int64
            personId:
              $ref: '#/components/schemas/PersonDAO'

    MembershipType:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/MembershipTypeRef'
    #Person:
    #  x-already-exists: true
    #  required: [assignId]
    #  properties:
    #    id:
    #      type: integer
    DonationDAO:
      x-has-dao: true
      required: [donationId, fundId, initiativeId, state]
      allOf:
        - $ref: './shared.yaml#/components/schemas/DonationFull'
        - type: object
          properties:
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItemId:
              x-backref-name: donation
              allOf:
                - $ref: '#/components/schemas/LineItem'
    PersonDAO:
      x-has-dao: true
      required: [personId, relationsA, relationsB]
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonInternalFull'
        - type: object
          properties:
            assignId:
              x-table-name: persons
              x-col-primary: true
              x-dto-column: PERSON_ID
              x-auto-increment: PERSONS_SEQ
              type: integer
            relationsA:
              x-parent-variable: B
              x-column-parent-fk: A
              type: array
              items:
                $ref: '#/components/schemas/PersonRelationDAO'
            pwHash:
              type: string
              maxLength: 100
            relationsB:
              x-parent-variable: A
              x-column-parent-fk: B
              type: array
              items:
                $ref: '#/components/schemas/PersonRelationDAO'
            memberships:
              x-parent-variable: personId
              type: array
              items:
                $ref: '#/components/schemas/MembershipDAO'
            cards:
              x-optional-ref: true
              x-parent-variable: personId
              type: array
              items:
                $ref: '#/components/schemas/CardDAO'
            referrals:
              type: array
              x-parent-variable: personId
              items:
                $ref: '#/components/schemas/PersonReferralDAO'
            addresses:
              x-parent-variable: personId
              type: array
              items:
                $ref: '#/components/schemas/PersonAddressDAO'
            phones:
              x-parent-variable: personId
              type: array
              items:
                $ref: '#/components/schemas/PersonPhoneDAO'

    MembershipDAO:
      x-has-dao: true
      required: [assignId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/MembershipInternal'
        - type: object
          properties:
            assignId:
              x-table-name: persons_memberships
              x-auto-increment: PERSONS_MEMBERSHIPS_SEQ
              x-col-primary: true
              type: integer
            membershipTypeId:
              $ref: "#/components/schemas/MembershipType"
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItemId:
              x-backref-name: membership
              allOf:
                - $ref: '#/components/schemas/LineItem'
    CardDAO:
      x-has-dao: true
      required: [ assignId ]
      allOf:
        - $ref: './shared.yaml#/components/schemas/CardFull'
        - type: object
          properties:
            assignId:
              x-table-name: persons_cards
              x-auto-increment: PERSONS_CARDS_SEQ
              x-col-primary: true
              type: integer
            personId:
              $ref: '#/components/schemas/PersonDAO'
            lineItemId:
              x-backref-name: card
              allOf:
                - $ref: '#/components/schemas/LineItem'
    PersonRelationDAO:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/PersonRelation'
        - type: object
          required: [A, B, relationId]
          properties:
            relationId:
              type: integer
              x-auto-increment: PERSON_RELATIONSHIPS_SEQ
              x-col-primary: true
              x-table-name: person_relationships
            A:
              x-dto-column: A
              allOf:
                - $ref: '#/components/schemas/PersonDAO'
            B:
              x-dto-column: B
              allOf:
                - $ref: '#/components/schemas/PersonDAO'



    DiscountInstance:
      x-has-dao: true
      required: [instanceId]
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountInstanceInternalFull'

    Discount:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/DiscountFull'
        - type: object
          properties:
            catalogId:
              $ref: '#/components/schemas/Catalog'
            categories:
              type: array
              items:
                $ref: '#/components/schemas/DiscountCategory'
            instances:
              type: array
              items:
                $ref: '#/components/schemas/DiscountInstance'

    CashDrawer:
      x-has-dao: true
      allOf:
        - $ref: './shared.yaml#/components/schemas/CashDrawerFull'